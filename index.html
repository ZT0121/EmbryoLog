<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Embryo Log</title>

  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#e6ecef">
  <link rel="icon" href="./favicon.png" type="image/png">
  
  <!-- ICON / FAVICON -->
  <link rel="icon" type="image/png"
        href="https://drive.google.com/uc?export=view&id=1MwiYzHvmYyHfBCj1S9OIShy3vc3YIzmU">
  <link rel="apple-touch-icon"
        href="https://drive.google.com/uc?export=view&id=1MwiYzHvmYyHfBCj1S9OIShy3vc3YIzmU">

  <style>
    :root{
      --bg:#f6f6f6;
      --text:#2f2f2f;
      --muted:#6b6b6b;

      --d1:#E6ECEF; --d1h:#CBD7DE;
      --d2:#E8EFEA; --d2h:#CEDDD3;
      --d3:#EEEAF1; --d3h:#D9D0E1;
      --d5:#F2ECE6; --d5h:#E2D6C8;
      --d7:#EFEFEF; --d7h:#DADADA;

      --card:#ffffff;
      --line:#e2e2e2;
      --btn:#ffffff;
      --shadow: 0 10px 30px rgba(0,0,0,.06);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", "Microsoft JhengHei", Arial, sans-serif;
    }
    .wrap{max-width:1200px; margin:0 auto; padding:18px}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin-bottom:14px;
    }
    .title{display:flex; flex-direction:column; gap:6px;}
    .title h1{margin:0; font-size:28px; letter-spacing:.2px}
    .title .sub{color:var(--muted); font-size:12px}
    .actions{display:flex; gap:10px; align-items:center}
    .btn{
      border:1px solid var(--line); background:var(--btn); padding:9px 12px;
      border-radius:12px; cursor:pointer; font-weight:600;
    }
    .btn:active{transform:translateY(1px)}
    .pill{
      padding:7px 10px; border-radius:999px; border:1px solid var(--line);
      font-family:var(--mono); font-size:12px; color:var(--muted);
      background:#fff;
    }

    .summary{
      display:grid; grid-template-columns: repeat(6, minmax(0,1fr));
      gap:10px; margin-bottom:14px;
    }
    .sumcard{
      background:#fff; border:1px solid var(--line); border-radius:16px;
      padding:10px 12px; box-shadow: var(--shadow);
    }
    .sumcard .k{color:var(--muted); font-size:12px}
    .sumcard .v{font-size:18px; font-weight:800; margin-top:2px}

    .grid{
      display:grid; gap:12px;
      grid-template-columns: repeat(5, minmax(240px, 1fr));
      align-items:start;
    }
    @media (max-width: 1250px){
      .grid{grid-template-columns: repeat(2, minmax(240px, 1fr));}
      .summary{grid-template-columns: repeat(3, minmax(0,1fr));}
    }
    @media (max-width: 700px){
      .grid{grid-template-columns: 1fr;}
      .summary{grid-template-columns: repeat(2, minmax(0,1fr));}
    }

    .col{
      border-radius: var(--radius);
      overflow:hidden;
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      background:#fff;
    }
    .colhead{
      padding:10px 12px;
      display:flex; align-items:center; justify-content:space-between;
      font-weight:900;
    }
    .colhead small{font-weight:700; color:rgba(0,0,0,.55)}
    .colbody{padding:10px 10px 12px; background:rgba(255,255,255,.65)}
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:16px;
      padding:10px; margin-bottom:10px;
    }
    .row1{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .mrn{font-family:var(--mono); font-size:12px; color:var(--muted); white-space:nowrap}
    .name{font-weight:900; line-height:1.2; white-space:normal; word-break:break-word;}
    .meta{color:var(--muted); font-size:12px; margin-top:6px; line-height:1.35}
    .tags{display:flex; flex-wrap:wrap; gap:6px; margin-top:8px}
    .tag{
      font-size:11px; padding:5px 8px; border-radius:999px;
      border:1px solid var(--line); color:#3b3b3b; background:#fafafa;
    }

    /* âœ¨ æ–°å¢ Culture æ¨™ç±¤æ¨£å¼ */
    .culture-badge {
      display: inline-block;
      background-color: #e3f2fd; /* æ·¡è—è‰²åº• */
      color: #0d47a1;           /* æ·±è—è‰²å­— */
      font-size: 11px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid #bbdefb;
      margin-right: 4px;        /* èˆ‡ç—…æ­·è™Ÿçš„é–“è· */
      vertical-align: middle;
    }
    
    .controls{display:grid; gap:8px; margin-top:10px}
    .ctrl{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:8px 10px; border-radius:14px; border:1px solid var(--line);
      background:#fff;
    }
    .ctrl label{font-size:12px; color:var(--muted); font-weight:700}
    .ctrl select{
      width:140px; padding:7px 10px; border-radius:12px; border:1px solid var(--line);
      background:#fff; font-weight:700;
    }
    .ctrl input[type="checkbox"]{transform: scale(1.2);}
    .empty{color:var(--muted); font-size:12px; padding:12px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>Embryo Log</h1>
        <div class="sub">Today: <span id="today" class="pill">â€”</span></div>
      </div>
      <div class="actions">
        <button class="btn" id="btnReload">åˆ·æ–°</button>
        <span class="pill" id="status">ready</span>
      </div>
    </div>

    <div class="summary" id="summary"></div>

    <div class="grid">
      <div class="col">
        <div class="colhead" style="background:var(--d1h)">D1 <small id="cntD1">0</small></div>
        <div class="colbody" style="background:var(--d1)"><div id="listD1"></div></div>
      </div>
      <div class="col">
        <div class="colhead" style="background:var(--d2h)">D2 <small id="cntD2">0</small></div>
        <div class="colbody" style="background:var(--d2)"><div id="listD2"></div></div>
      </div>
      <div class="col">
        <div class="colhead" style="background:var(--d3h)">D3 <small id="cntD3">0</small></div>
        <div class="colbody" style="background:var(--d3)"><div id="listD3"></div></div>
      </div>
      <div class="col">
        <div class="colhead" style="background:var(--d5h)">D5 <small id="cntD5">0</small></div>
        <div class="colbody" style="background:var(--d5)"><div id="listD5"></div></div>
      </div>
      <div class="col">
        <div class="colhead" style="background:var(--d7h)">D7 <small id="cntD7">0</small></div>
        <div class="colbody" style="background:var(--d7)"><div id="listD7"></div></div>
      </div>
    </div>
  </div>

<script>
  // âœ… æ›æˆä½ çš„ Apps Script Web App /exec
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycby1aYmcPmRoLjW24rCTpFUmA9tj7Atsfzw3kFsF7og3Q03xYJfGDtFLb8mCHz9uyN4MmA/exec";

  const $ = (id)=>document.getElementById(id);
  function setStatus(txt){ $('status').textContent = txt; }

  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

// =========================
// JSONP helper (no CORS)
// =========================
function jsonp(url, timeoutMs = 15000){
  return new Promise((resolve, reject) => {
    const cb = `cb_${Date.now()}_${Math.random().toString(16).slice(2)}`;
    const sep = url.includes('?') ? '&' : '?';
    const full = `${url}${sep}cb=${encodeURIComponent(cb)}`;

    const s = document.createElement('script');
    let done = false;

    const timer = setTimeout(() => {
      if (done) return;
      done = true;
      cleanup();
      reject(new Error('JSONP timeout'));
    }, timeoutMs);

    function cleanup(){
      clearTimeout(timer);
      try { delete window[cb]; } catch {}
      if (s && s.parentNode) s.parentNode.removeChild(s);
    }

    window[cb] = (data) => {
      if (done) return;
      done = true;
      cleanup();
      resolve(data);
    };

    s.onerror = () => {
      if (done) return;
      done = true;
      cleanup();
      reject(new Error('JSONP load error'));
    };

    s.src = full;
    document.body.appendChild(s);
  });
}

async function apiGet(fn){
  const url = `${WEBAPP_URL}?jsonp=1&fn=${encodeURIComponent(fn)}`;
  return await jsonp(url);
}

async function apiPost(fn, payload){
  const { mrn, d0, field, value } = payload || {};
  const v = (typeof value === 'boolean') ? String(value) : String(value ?? '');

  const url = `${WEBAPP_URL}?jsonp=1&fn=${encodeURIComponent(fn)}`
    + `&mrn=${encodeURIComponent(mrn)}`
    + `&d0=${encodeURIComponent(d0)}`
    + `&field=${encodeURIComponent(field)}`
    + `&value=${encodeURIComponent(v)}`;

  return await jsonp(url);
}

  function renderSummary(s){
    const items = [
      ['TOTAL', s.total ?? 0],
      ['D1', s.D1 ?? 0],
      ['D2', s.D2 ?? 0],
      ['D3', s.D3 ?? 0],
      ['D5', s.D5 ?? 0],
      ['D7', s.D7 ?? 0],
    ];
    $('summary').innerHTML = items.map(([k,v])=>`
      <div class="sumcard">
        <div class="k">${k}</div>
        <div class="v">${v}</div>
      </div>
    `).join('');
  }

function cardHTML(day, t){
    const meta = `${t.d0} Â· ${escapeHtml(t.doctor)} Â· ${escapeHtml(t.therapy)}`;
    const note = t.note ? `<div class="meta">å‚™è¨»ï¼š${escapeHtml(t.note)}</div>` : '';

    // âœ¨ è™•ç† Culture é¡¯ç¤º HTML
    const cultureHtml = t.culture 
      ? `<span class="culture-badge">ğŸ§« ${escapeHtml(t.culture)}</span>` 
      : '';

    const tags = [];
    if (t.state?.needD3) tags.push('éœ€è¦D3å›å ±');
    if (t.state?.needD5) tags.push('éœ€è¦D5å›å ±');
    if (t.state?.add_d7) tags.push('Add D7');
    const tagHtml = tags.length ? `<div class="tags">${tags.map(x=>`<span class="tag">${x}</span>`).join('')}</div>` : '';

    // å§“åæ›è¡Œ
    const nameHtml = escapeHtml(t.name || '').replace(/\n/g, '<br>');

    let controls = '';
    if (day === 'D1') {
      controls = `
        <div class="controls">
          <div class="ctrl">
            <label>D1 2PN check</label>
            <select onchange="upd('${t.mrn}','${t.d0}','D1 2PN check', this.value, true)">
              <option value="" ${t.state?.d1_2pn===''?'selected':''}></option>
              <option value="ğŸ¥³éåŠ" ${t.state?.d1_2pn==='ğŸ¥³éåŠ'?'selected':''}>ğŸ¥³éåŠ</option>
              <option value="ğŸ¤¡æœªéåŠ" ${t.state?.d1_2pn==='ğŸ¤¡æœªéåŠ'?'selected':''}>ğŸ¤¡æœªéåŠ</option>
            </select>
          </div>
          <div class="ctrl">
            <label>D1 Call</label>
            <input type="checkbox" ${t.state?.d1_call?'checked':''}
              onchange="upd('${t.mrn}','${t.d0}','D1 Call', this.checked, true)">
          </div>
          <div class="ctrl">
            <label>D1 Rescue</label>
            <input type="checkbox" ${t.state?.d1_rescue?'checked':''}
              onchange="upd('${t.mrn}','${t.d0}','D1 Rescue', this.checked)">
          </div>
        </div>
      `;
    }

    if (day === 'D2') {
      controls = `
        <div class="controls">
          <div class="ctrl">
            <label>D2 Doneï¼ˆè£œæ•‘å—ç²¾å›å ±ï¼‰</label>
            <input type="checkbox" ${t.state?.d2_done?'checked':''}
              onchange="upd('${t.mrn}','${t.d0}','D2 Done', this.checked, true)">
          </div>
        </div>
      `;
    }

    if (day === 'D3') {
      controls = `
        <div class="controls">
          <div class="ctrl">
            <label>D3 Done</label>
            <input type="checkbox" ${t.state?.d3_done?'checked':''}
              onchange="upd('${t.mrn}','${t.d0}','D3 Done', this.checked, true)">
          </div>
        </div>
      `;
    }

    if (day === 'D5') {
      controls = `
        <div class="controls">
          <div class="ctrl">
            <label>D5 Done</label>
            <input type="checkbox" ${t.state?.d5_done?'checked':''}
              onchange="upd('${t.mrn}','${t.d0}','D5 Done', this.checked, true)">
          </div>
          <div class="ctrl">
            <label>D7 å†å ±</label>
            <input type="checkbox" ${t.state?.add_d7?'checked':''}
              onchange="upd('${t.mrn}','${t.d0}','Add D7', this.checked)">
          </div>
        </div>
      `;
    }

    if (day === 'D7') {
      controls = `
        <div class="controls">
          <div class="ctrl">
            <label>D7 Doneï¼ˆæœ€çµ‚å›å ±ï¼‰</label>
            <input type="checkbox" ${t.state?.d7_done?'checked':''}
              onchange="upd('${t.mrn}','${t.d0}','D7 Done', this.checked, true)">
          </div>
        </div>
      `;
    }

    return `
      <div class="card">
        <div class="row1">
          <div class="name">${nameHtml}</div>
          <div class="mrn">${escapeHtml(t.mrn || '')}</div>
        </div>
        <div class="meta">${escapeHtml(meta)}</div>
        ${note}
        ${tagHtml}
        ${controls}
      </div>
    `;
  }

  function renderList(day, arr){
    $('cnt'+day).textContent = arr.length;
    const box = $('list'+day);
    if (!arr.length) { box.innerHTML = `<div class="empty">ä»Šå¤©æ²’æœ‰ ${day} å¾…è¾¦</div>`; return; }
    box.innerHTML = arr.map(t => cardHTML(day, t)).join('');
  }

  async function load(){
    try{
      setStatus('loadingâ€¦');
      const res = await apiGet('getTodayTasks');
      $('today').textContent = res.today || 'â€”';
      renderSummary(res.summary || {});
      renderList('D1', res.lists?.D1 || []);
      renderList('D2', res.lists?.D2 || []);
      renderList('D3', res.lists?.D3 || []);
      renderList('D5', res.lists?.D5 || []);
      renderList('D7', res.lists?.D7 || []);
      setStatus('ok');
    }catch(e){
      setStatus('error');
      alert(e.message || e);
    }
  }

  async function upd(mrn, d0, field, value, refreshAfter){
    try{
      setStatus('savingâ€¦');
      const r = await apiPost('updateField', { mrn, d0, field, value });
      if(!r || r.ok !== true) throw new Error(r?.error || 'update failed');
      setStatus('ok');
      if (refreshAfter) await load();
    }catch(e){
      setStatus('error');
      alert(e.message || e);
    }
  }

  $('btnReload').addEventListener('click', load);
  load();
</script>

  <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js");
  }
</script>
  
</body>
</html>
